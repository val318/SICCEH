<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SICCE ‚Äì ENCB</title>
  <style>
    :root{
      --primary:#7a003c; --primary-dark:#5a002d; --bg:#f4f4f4; --card:#fff; --text:#222;
    }
    [data-theme="dark"]{
      --bg:#0f1112; --card:#121212; --text:#eee;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:var(--text)}
    header{background:var(--primary);color:#fff;padding:18px;text-align:center}
    main{max-width:1100px;margin:20px auto;padding:18px;display:none}
    .card{background:var(--card);padding:18px;border-radius:10px;margin-bottom:18px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    input,select,button,textarea{font-family:inherit;font-size:15px}
    input,select,textarea{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc;background:transparent;color:var(--text)}
    button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
    button:hover{background:var(--primary-dark)}
    nav{display:none;background:var(--card);padding:12px;border-radius:10px;margin:0 auto 18px;max-width:1100px;align-items:center;display:flex}
    nav a{margin-right:12px;color:var(--primary);text-decoration:none;font-weight:600}
    .small{font-size:13px;color:gray;margin-top:8px}
    .table-wrap{overflow:auto;max-height:380px;margin-top:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid rgba(0,0,0,.08);font-size:14px;text-align:left}
    .profile-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:20px}
    .profile-modal .card{width:360px;max-width:95%}
    .pulse{animation:pop .6s ease}
    @keyframes pop{0%{transform:scale(.9)}60%{transform:scale(1.05)}100%{transform:scale(1)}}
  </style>
</head>
<body>
<header>
  <h1>SICCE ‚Äî Sistema Integral de Captura de Colillas</h1>
  <p class="small">ENCB ¬∑ Proyecto de recolecci√≥n y biodegradaci√≥n</p>
</header>

<!-- LOGIN -->
<section id="loginScreen" class="card" style="max-width:420px;margin:28px auto">
  <h2>Iniciar sesi√≥n</h2>
  <input id="loginEmail" type="email" placeholder="Correo institucional">
  <input id="loginPass" type="password" placeholder="Contrase√±a">
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="btnLogin" style="flex:1">Entrar</button>
    <button id="btnShowRegister" style="flex:1">Crear cuenta</button>
  </div>
  <p id="loginMsg" class="small"></p>
</section>

<!-- REGISTRO -->
<section id="registroScreen" class="card" style="display:none;max-width:420px;margin:28px auto">
  <h2>Crear cuenta</h2>
  <input id="regEmail" type="email" placeholder="Correo institucional">
  <input id="regPass" type="password" placeholder="Contrase√±a">
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="btnRegister" style="flex:1">Registrarse</button>
    <button id="btnCancelRegister" style="flex:1">Cancelar</button>
  </div>
  <p id="regMsg" class="small"></p>
</section>

<!-- NAV -->
<nav id="menu" style="display:none">
  <a href="#intro">Introducci√≥n</a>
  <a href="#registro">Registrar</a>
  <a href="#impacto">Impacto</a>
  <a href="#historial">Historial</a>
  <a href="#adminPanel" id="adminBtn" style="display:none">Administraci√≥n</a>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <button id="btnTheme">Modo oscuro</button>
    <button id="btnProfile">Perfil</button>
    <button id="btnLogout">Salir</button>
  </div>
</nav>

<!-- MAIN -->
<main id="contenido" style="display:none">
  <section id="intro" class="card">
    <h2>Introducci√≥n</h2>
    <p>Sistema SICCE para recolecci√≥n y biodegradaci√≥n de colillas: registro, historial, recompensas y administraci√≥n.</p>
  </section>

  <section id="registro" class="card">
    <h2>Registrar colillas</h2>
    <p id="userLabel" class="small"></p>
    <input id="colillasInput" type="number" placeholder="Cantidad de colillas">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btnSaveColillas">Guardar</button>
      <button id="btnGenerateQR">Generar QR</button>
    </div>
    <p id="saveMsg" class="small"></p>
    <h3>Total acumulado: <span id="totalUser">0</span></h3>
    <div id="chartContainer" style="max-width:700px"><canvas id="chartCanvas"></canvas></div>
  </section>

  <section id="impacto" class="card">
    <h2>Impacto</h2>
    <p>Nivel: <span id="badgeLevel">0</span> ‚Äî Rango: <span id="badgeRank">Principiante</span></p>
  </section>

  <section id="historial" class="card">
    <h2>Historial de dep√≥sitos</h2>
    <label>Eliminar por fecha (usuario):</label>
    <input type="date" id="delDate" style="margin-top:8px">
    <button id="btnDeleteByDate" style="margin-top:8px">Eliminar por fecha</button>
    <ul id="historialLista" class="small" style="margin-top:14px"></ul>
  </section>

  <section id="adminPanel" class="card" style="display:none">
    <h2>Panel de Administraci√≥n</h2>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <label style="min-width:140px">Seleccionar usuario:</label>
      <select id="adminUserSelect" style="flex:1"></select>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <input type="date" id="adminDelDate">
      <button id="btnAdminDeleteByDate">Borrar historial por fecha</button>
      <button id="btnAdminDeleteAll">Borrar todo historial</button>
    </div>

    <hr style="margin:12px 0">

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnRefreshAdmin">Actualizar</button>
      <button id="btnExportCSV">Exportar CSV</button>
      <button id="btnResetAll">Reiniciar todo</button>
    </div>

    <div id="adminList" class="table-wrap" style="margin-top:12px"></div>
  </section>
</main>

<!-- Profile modal -->
<div class="profile-modal" id="profileModal">
  <div class="card">
    <h3>Perfil</h3>
    <p id="pEmail"></p>
    <p id="pColillas"></p>
    <p id="pNivel"></p>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="btnCloseProfile">Cerrar</button>
    </div>
  </div>
</div>

<!-- QR modal -->
<div class="profile-modal" id="qrModal">
  <div class="card center">
    <h3>QR para contenedor</h3>
    <img id="qrImg" alt="QR" style="width:220px;height:220px">
    <div style="display:flex;justify-content:center;gap:8px;margin-top:12px">
      <button id="btnDownloadQR">Descargar</button>
      <button id="btnCloseQR">Cerrar</button>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Supabase client (usar m√≥dulo) -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// --- Configuraci√≥n Supabase ---
const SUPABASE_URL = 'https://xarfnkjrynrlagqbzapb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhcmZua2pyeW5ybGFncWJ6YXBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0ODUwNTYsImV4cCI6MjA4MTA2MTA1Nn0.XSeaEKlaz7LDFpZt9O1OC0EVQ-W7BFIy3SKtuIg5h1E';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- DOM references ---
const loginScreen = document.getElementById('loginScreen');
const registroScreen = document.getElementById('registroScreen');
const menu = document.getElementById('menu');
const contenido = document.getElementById('contenido');

const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const loginMsg = document.getElementById('loginMsg');

const regEmail = document.getElementById('regEmail');
const regPass = document.getElementById('regPass');
const regMsg = document.getElementById('regMsg');

const btnLogin = document.getElementById('btnLogin');
const btnShowRegister = document.getElementById('btnShowRegister');
const btnRegister = document.getElementById('btnRegister');
const btnCancelRegister = document.getElementById('btnCancelRegister');

const userLabel = document.getElementById('userLabel');
const colillasInput = document.getElementById('colillasInput');
const btnSaveColillas = document.getElementById('btnSaveColillas');
const btnGenerateQR = document.getElementById('btnGenerateQR');
const saveMsg = document.getElementById('saveMsg');
const totalUser = document.getElementById('totalUser');

const badgeLevel = document.getElementById('badgeLevel');
const badgeRank = document.getElementById('badgeRank');

const adminBtn = document.getElementById('adminBtn');
const adminUserSelect = document.getElementById('adminUserSelect');
const adminDelDate = document.getElementById('adminDelDate');
const btnAdminDeleteByDate = document.getElementById('btnAdminDeleteByDate');
const btnAdminDeleteAll = document.getElementById('btnAdminDeleteAll');
const adminList = document.getElementById('adminList');
const btnRefreshAdmin = document.getElementById('btnRefreshAdmin');
const btnExportCSV = document.getElementById('btnExportCSV');
const btnResetAll = document.getElementById('btnResetAll');

const btnTheme = document.getElementById('btnTheme');
const btnProfile = document.getElementById('btnProfile');
const btnLogout = document.getElementById('btnLogout');

const profileModal = document.getElementById('profileModal');
const pEmail = document.getElementById('pEmail');
const pColillas = document.getElementById('pColillas');
const pNivel = document.getElementById('pNivel');
const btnCloseProfile = document.getElementById('btnCloseProfile');

const qrModal = document.getElementById('qrModal');
const qrImg = document.getElementById('qrImg');
const btnDownloadQR = document.getElementById('btnDownloadQR');
const btnCloseQR = document.getElementById('btnCloseQR');

const historialLista = document.getElementById('historialLista');
const delDate = document.getElementById('delDate');
const btnDeleteByDate = document.getElementById('btnDeleteByDate');

const chartCanvas = document.getElementById('chartCanvas');
let chartInstance = null;

// --- Event listeners ---
btnShowRegister.addEventListener('click', ()=>{ loginScreen.style.display='none'; registroScreen.style.display='block'; });
btnCancelRegister.addEventListener('click', ()=>{ registroScreen.style.display='none'; loginScreen.style.display='block'; });
btnRegister.addEventListener('click', registrarUsuario);
btnLogin.addEventListener('click', login);

btnSaveColillas.addEventListener('click', addColillas);
btnGenerateQR.addEventListener('click', generateQR);

btnAdminDeleteByDate.addEventListener('click', adminDeleteByDate);
btnAdminDeleteAll.addEventListener('click', adminDeleteAll);
btnRefreshAdmin.addEventListener('click', loadAdmin);
btnExportCSV.addEventListener('click', exportCSV);
btnResetAll.addEventListener('click', resetAll);

btnTheme.addEventListener('click', toggleTheme);
btnProfile.addEventListener('click', openProfile);
btnLogout.addEventListener('click', logout);

btnCloseProfile.addEventListener('click', closeProfile);
btnDownloadQR.addEventListener('click', downloadQR);
btnCloseQR.addEventListener('click', closeQR);

btnDeleteByDate.addEventListener('click', userDeleteByDate);

// --- Helpers ---
function sessionUserId(){ return sessionStorage.getItem('user_id'); }
function sessionUserEmail(){ return sessionStorage.getItem('user_email'); }

// --- Fetch profile ---
async function fetchProfile(user_id){
  if(!user_id) return null;
  const { data, error } = await supabase.from('profiles').select('*').eq('id', user_id).single();
  if(error) return null;
  return data;
}

// --- LOGIN ---
async function login(){
  const email = loginEmail.value.trim();
  const pass = loginPass.value;
  loginMsg.textContent = '';

  if(!email || !pass){ loginMsg.textContent = 'Completa los campos'; return; }

  const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
  if(error){ loginMsg.textContent = error.message; return; }

  const user = data.user || data.session?.user;
  if(!user){ loginMsg.textContent = 'No se pudo iniciar sesi√≥n'; return; }

  sessionStorage.setItem('user_id', user.id);
  sessionStorage.setItem('user_email', user.email || '');

  iniciarSistema();
}

// --- REGISTRO ---
async function registrarUsuario(){
  const email = regEmail.value.trim();
  const pass = regPass.value;
  regMsg.textContent = '';

  if(!email || !pass){ regMsg.textContent = 'Completa los campos'; return; }

  const { data, error } = await supabase.auth.signUp({ email, password: pass });
  if(error){ regMsg.textContent = error.message; return; }

  const userId = data.user?.id || data.session?.user?.id;
  if(userId){
    await supabase.from('profiles').insert({ id: userId, email, rango: 'Principiante', colillas: 0 });
  }

  regMsg.textContent = 'Cuenta creada correctamente';
  setTimeout(()=>{ registroScreen.style.display='none'; loginScreen.style.display='block'; loginEmail.value = email; }, 900);
}

// --- INICIAR SISTEMA ---
async function iniciarSistema(){
  loginScreen.style.display='none';
  registroScreen.style.display='none';
  menu.style.display='flex';
  contenido.style.display='block';

  const uid = sessionUserId();
  const profile = await fetchProfile(uid);

  if(profile && profile.is_admin) adminBtn.style.display = 'inline-block';
  else adminBtn.style.display = 'none';

  await cargarUsuario();
  renderChart();
  renderHistorial();
}

// --- CARGAR USUARIO ---
async function cargarUsuario(){
  const uid = sessionUserId();
  if(!uid) return;

  const profile = await fetchProfile(uid);
  if(!profile) return;

  userLabel.textContent = 'Usuario: ' + (profile.email || sessionUserEmail());
  totalUser.textContent = (profile.colillas || 0) + ' colillas';
  actualizarInsignias(profile.colillas || 0);
}

// --- AGREGAR COLILLAS ---
async function addColillas(){
  const uid = sessionUserId();
  if(!uid){ saveMsg.textContent = 'Inicia sesi√≥n primero'; return; }

  const cant = parseInt(colillasInput.value, 10);
  if(!cant || cant <= 0){ saveMsg.textContent = 'Cantidad inv√°lida'; return; }

  const { error: insErr } = await supabase.from('deposits').insert({ user_id: uid, cant });
  if(insErr){ saveMsg.textContent = 'Error al guardar: ' + insErr.message; return; }

  // recalcular total
  const { data: rows } = await supabase.from('deposits').select('cant').eq('user_id', uid);
  const total = (rows||[]).reduce((s,r)=>s+(r.cant||0), 0);
  await supabase.from('profiles').update({ colillas: total }).eq('id', uid);

  totalUser.textContent = total + ' colillas';
  saveMsg.textContent = 'Registrado correctamente';
  actualizarInsignias(total);
  renderChart();
  renderHistorial();
  colillasInput.value = '';
}

// --- Historial ---
async function renderHistorial(){
  const uid = sessionUserId();
  historialLista.innerHTML = '';
  if(!uid){ historialLista.innerHTML = '<li class="small">Inicia sesi√≥n para ver historial</li>'; return; }

  const { data, error } = await supabase.from('deposits').select('*').eq('user_id', uid).order('created_at', { ascending:false }).limit(200);
  if(error || !data || data.length===0){ historialLista.innerHTML = '<li class="small">Sin registros</li>'; return; }

  data.forEach(it=>{
    const li = document.createElement('li');
    li.innerHTML = `${new Date(it.created_at).toLocaleString()} ‚Äî <strong>${it.cant}</strong> colillas <button style="margin-left:8px" onclick="window.deleteHistSup('${it.id}')">üóë</button>`;
    historialLista.appendChild(li);
  });
}

// --- Eliminar individual (expuesto globalmente) ---
window.deleteHistSup = async function(id){
  if(!confirm('¬øEliminar este registro?')) return;
  const uid = sessionUserId();
  if(!uid) return;

  const { error } = await supabase.from('deposits').delete().eq('id', id).eq('user_id', uid);
  if(error){ alert('Error: '+error.message); return; }

  // recalcular total
  const { data: rows } = await supabase.from('deposits').select('cant').eq('user_id', uid);
  const total = (rows||[]).reduce((s,r)=>s+(r.cant||0),0);
  await supabase.from('profiles').update({ colillas: total }).eq('id', uid);

  cargarUsuario(); renderChart(); renderHistorial();
}

// --- Borrar por fecha ---
async function userDeleteByDate(){
  const uid = sessionUserId();
  if(!uid) return;

  const fechaSel = delDate.value;
  if(!fechaSel){ alert('Selecciona una fecha'); return; }

  const { data } = await supabase.from('deposits').select('*').eq('user_id', uid);
  const toDelete = (data||[]).filter(r=>{
    const d = new Date(r.created_at);
    const yyyy = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
    return (yyyy+'-'+mm+'-'+dd) === fechaSel;
  });

  if(toDelete.length===0){ alert('No se encontraron registros en esa fecha.'); return; }
  if(!confirm('Eliminar '+toDelete.length+' registros?')) return;

  const ids = toDelete.map(r=>r.id);
  await supabase.from('deposits').delete().in('id', ids);

  const { data: rows } = await supabase.from('deposits').select('cant').eq('user_id', uid);
  const total = (rows||[]).reduce((s,r)=>s+(r.cant||0),0);
  await supabase.from('profiles').update({ colillas: total }).eq('id', uid);

  cargarUsuario(); renderChart(); renderHistorial();
  alert('Registros eliminados: '+toDelete.length);
}

// --- Insignias ---
function actualizarInsignias(total){
  const c = total || 0;
  let nivel = 0, rango = 'Principiante';
  if(c>=300){ nivel=3; rango='Guardi√°n Ambiental'; }
  else if(c>=150){ nivel=2; rango='Protector del Campus'; }
  else if(c>=50){ nivel=1; rango='Recolector Inicial'; }
  badgeLevel.textContent = nivel;
  badgeRank.textContent = rango;
  badgeLevel.classList.add('pulse'); badgeRank.classList.add('pulse');
  setTimeout(()=>{ badgeLevel.classList.remove('pulse'); badgeRank.classList.remove('pulse'); }, 700);
}

// --- Chart ---
async function renderChart(){
  const uid = sessionUserId();
  const { data: allProfiles } = await supabase.from('profiles').select('colillas');
  const total = (allProfiles||[]).reduce((s,p)=>s+(p.colillas||0),0);
  const { data: me } = await supabase.from('profiles').select('colillas').eq('id', uid).single();
  const myVal = me?.colillas || 0;

  const ctx = chartCanvas.getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type:'bar',
    data:{ labels:['Total campus','T√∫'], datasets:[{ label:'Colillas', data:[total,myVal], backgroundColor:['#7a003c','#2979ff'] }] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  });
}

// --- Resto de funciones Admin, QR, Tema, Logout ---
// (Se mantienen igual, solo aseg√∫rate que usan sessionUserId() para RLS)

// --- Init ---
window.addEventListener('load', async ()=>{
  if(localStorage.getItem('sicce_theme_v1')==='dark'){ document.documentElement.setAttribute('data-theme','dark'); btnTheme.textContent='Modo claro'; }
  else{ document.documentElement.removeAttribute('data-theme'); btnTheme.textContent='Modo oscuro'; }

  const { data: { session } } = await supabase.auth.getSession();
  if(session && session.user){
    sessionStorage.setItem('user_id', session.user.id);
    sessionStorage.setItem('user_email', session.user.email || '');
    iniciarSistema();
  } else {
    loginScreen.style.display='block';
    registroScreen.style.display='none';
    menu.style.display='none';
    contenido.style.display='none';
  }
});
</script>
</body>
</html>
