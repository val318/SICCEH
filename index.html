<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SICCE â€“ ENCB</title>
<style>
:root{
  --primary:#6c0538; --primary-dark:#83034382; --bg:#f4f4f4; --card:#fff; --text:#222;
}
[data-theme="dark"]{
  --bg:#0f1112; --card:#121212; --text:#eee;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial, sans-serif;background:var(--bg);color:var(--text)}
header{background:var(--primary);color:#fff;padding:18px;text-align:center}
main{max-width:1100px;margin:20px auto;padding:18px;display:none}
.card{background:var(--card);padding:18px;border-radius:10px;margin-bottom:18px;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:transform 0.2s;}
.card:hover{transform:translateY(-3px);}
input,select,button,textarea{font-family:inherit;font-size:15px}
input,select,textarea{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc;background:transparent;color:var(--text)}
button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
button:hover{background:var(--primary-dark)}
nav{display:none;background:var(--card);padding:12px;border-radius:10px;margin:0 auto 18px;max-width:1100px;align-items:center;display:flex}
nav a{margin-right:12px;color:var(--primary);text-decoration:none;font-weight:600}
.small{font-size:13px;color:gray;margin-top:8px}
.table-wrap{overflow:auto;max-height:380px;margin-top:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid rgba(0,0,0,.08);font-size:14px;text-align:left}
.profile-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:20px}
.profile-modal .card{width:360px;max-width:95%}
.pulse{animation:pop .6s ease}
@keyframes pop{0%{transform:scale(.9)}60%{transform:scale(1.05)}100%{transform:scale(1)}}

/* Progreso */
.progress-bar{
  width:100%;background:#eee;border-radius:10px;margin:8px 0;
  height:20px;overflow:hidden;
}
.progress-fill{
  height:100%;border-radius:10px;background:#28a745;width:0%;
  text-align:center;color:#fff;font-size:12px;line-height:20px;
  transition:width 0.8s ease, background-color 0.5s ease;
}
</style>
</head>
<body>
<header>
  <h1>SICCE â€” Sistema Integral de Captura de Colillas</h1>
  <p class="small">ENCB Â· Proyecto de recolecciÃ³n y biodegradaciÃ³n</p>
</header>

<!-- LOGIN -->
<section id="loginScreen" class="card" style="max-width:420px;margin:28px auto">
  <h2>Iniciar sesiÃ³n</h2>
  <input id="loginEmail" type="email" placeholder="Correo institucional">
  <input id="loginPass" type="password" placeholder="ContraseÃ±a">
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="btnLogin" style="flex:1">Entrar</button>
    <button id="btnShowRegister" style="flex:1">Crear cuenta</button>
  </div>
  <p id="loginMsg" class="small"></p>
</section>

<!-- REGISTRO -->
<section id="registroScreen" class="card" style="display:none;max-width:420px;margin:28px auto">
  <h2>Crear cuenta</h2>
  <input id="regEmail" type="email" placeholder="Correo institucional">
  <input id="regPass" type="password" placeholder="ContraseÃ±a">
  <div style="display:flex;gap:8px;margin-top:10px">
    <button id="btnRegister" style="flex:1">Registrarse</button>
    <button id="btnCancelRegister" style="flex:1">Cancelar</button>
  </div>
  <p id="regMsg" class="small"></p>
</section>

<!-- NAV -->
<nav id="menu" style="display:none">
  <a href="#intro">Â¿Quienes somos?</a>
  <a href="#registro">Registrar</a>
  <a href="#impacto">Impacto</a>
  <a href="#historial">Historial</a>
  <a href="#adminPanel" id="adminBtn" style="display:none">AdministraciÃ³n</a>
  <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
    <button id="btnTheme">Modo oscuro</button>
    <button id="btnProfile">Perfil</button>
    <button id="btnLogout">Salir</button>
  </div>
</nav>

<!-- MAIN -->
<main id="contenido" style="display:none">
  <section id="intro" class="card">
    <h2>IntroducciÃ³n</h2>
    <p>La contaminaciÃ³n por colillas de cigarro es un problema ambiental global... Participa y ayudanos con la lucha contra la contaminaciÃ³n</p>
  </section>

  <section id="registro" class="card">
    <h2>Registrar colillas</h2>
    <p id="userLabel" class="small"></p>
    <input id="colillasInput" type="number" placeholder="Cantidad de colillas">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="btnSaveColillas">Guardar</button>
    </div>
    <p id="saveMsg" class="small"></p>
    <h3>Total acumulado: <span id="totalUser">0</span></h3>
    <div class="progress-bar">
      <div class="progress-fill" id="progressColillas">0%</div>
    </div>
    <p>Rango actual: <span id="badgeRank">Principiante</span> <span id="badgeLevelIcon">ðŸ”°</span></p>
    <div id="chartContainer" style="max-width:700px"><canvas id="chartCanvas"></canvas></div>
  </section>

  <section id="impacto" class="card">
    <h2>Impacto</h2>
    <p>Nivel: <span id="badgeLevel">0</span></p>
  </section>

  <section id="historial" class="card">
    <h2>Historial de depÃ³sitos</h2>
    <label>Eliminar por fecha (usuario):</label>
    <input type="date" id="delDate" style="margin-top:8px">
    <button id="btnDeleteByDate" style="margin-top:8px">Eliminar por fecha</button>
    <ul id="historialLista" class="small" style="margin-top:14px"></ul>
  </section>

  <section id="adminPanel" class="card" style="display:none">
    <h2>Panel de AdministraciÃ³n</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <label style="min-width:140px">Seleccionar usuario:</label>
      <select id="adminUserSelect" style="flex:1"></select>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <input type="date" id="adminDelDate">
      <button id="btnAdminDeleteByDate">Borrar historial por fecha</button>
      <button id="btnAdminDeleteAll">Borrar todo historial</button>
    </div>
    <hr style="margin:12px 0">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button id="btnRefreshAdmin">Actualizar</button>
      <button id="btnExportCSV">Exportar CSV</button>
      <button id="btnResetAll">Reiniciar todo</button>
    </div>
    <div id="adminList" class="table-wrap" style="margin-top:12px"></div>
  </section>
</main>

<!-- Profile modal -->
<div class="profile-modal" id="profileModal">
  <div class="card">
    <h3>Perfil</h3>
    <p id="pEmail"></p>
    <p id="pColillas"></p>
    <p id="pNivel"></p>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="btnCloseProfile">Cerrar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// -----------------------
// DB y utilidades
// -----------------------
const STORAGE_KEY = 'sicceDB_complete_v1';
let db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
function saveDB(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
if(!db['valeriavlv318@gmail.com']){
  db['valeriavlv318@gmail.com'] = { colillas:0, nivel:0, rango:'Administrador', contraseÃ±a:'V@leria18', isAdmin:true, historial:[] };
  saveDB();
}

// -----------------------
// Refs DOM
// -----------------------
const loginScreen=document.getElementById('loginScreen');
const registroScreen=document.getElementById('registroScreen');
const menu=document.getElementById('menu');
const contenido=document.getElementById('contenido');
const loginEmail=document.getElementById('loginEmail');
const loginPass=document.getElementById('loginPass');
const loginMsg=document.getElementById('loginMsg');
const regEmail=document.getElementById('regEmail');
const regPass=document.getElementById('regPass');
const regMsg=document.getElementById('regMsg');
const btnLogin=document.getElementById('btnLogin');
const btnShowRegister=document.getElementById('btnShowRegister');
const btnRegister=document.getElementById('btnRegister');
const btnCancelRegister=document.getElementById('btnCancelRegister');
const userLabel=document.getElementById('userLabel');
const colillasInput=document.getElementById('colillasInput');
const btnSaveColillas=document.getElementById('btnSaveColillas');
const saveMsg=document.getElementById('saveMsg');
const totalUser=document.getElementById('totalUser');
const badgeLevel=document.getElementById('badgeLevel');
const badgeRank=document.getElementById('badgeRank');
const badgeLevelIcon=document.getElementById('badgeLevelIcon');
const adminBtn=document.getElementById('adminBtn');
const adminUserSelect=document.getElementById('adminUserSelect');
const adminDelDate=document.getElementById('adminDelDate');
const btnAdminDeleteByDate=document.getElementById('btnAdminDeleteByDate');
const btnAdminDeleteAll=document.getElementById('btnAdminDeleteAll');
const adminList=document.getElementById('adminList');
const btnRefreshAdmin=document.getElementById('btnRefreshAdmin');
const btnExportCSV=document.getElementById('btnExportCSV');
const btnResetAll=document.getElementById('btnResetAll');
const btnTheme=document.getElementById('btnTheme');
const btnProfile=document.getElementById('btnProfile');
const btnLogout=document.getElementById('btnLogout');
const profileModal=document.getElementById('profileModal');
const pEmail=document.getElementById('pEmail');
const pColillas=document.getElementById('pColillas');
const pNivel=document.getElementById('pNivel');
const historialLista=document.getElementById('historialLista');
const delDate=document.getElementById('delDate');
const btnDeleteByDate=document.getElementById('btnDeleteByDate');
const chartCanvas=document.getElementById('chartCanvas');
let chartInstance=null;

// -----------------------
// Eventos
// -----------------------
btnShowRegister.addEventListener('click', ()=>{ loginScreen.style.display='none'; registroScreen.style.display='block'; });
btnCancelRegister.addEventListener('click', ()=>{ registroScreen.style.display='none'; loginScreen.style.display='block'; });
btnRegister.addEventListener('click', registrarUsuario);
btnLogin.addEventListener('click', login);
btnSaveColillas.addEventListener('click', addColillas);
btnAdminDeleteByDate.addEventListener('click', adminDeleteByDate);
btnAdminDeleteAll.addEventListener('click', adminDeleteAll);
btnRefreshAdmin.addEventListener('click', loadAdmin);
btnExportCSV.addEventListener('click', exportCSV);
btnResetAll.addEventListener('click', resetAll);
btnTheme.addEventListener('click', toggleTheme);
btnProfile.addEventListener('click', openProfile);
btnLogout.addEventListener('click', logout);
btnCloseProfile.addEventListener('click', closeProfile);
btnDeleteByDate.addEventListener('click', userDeleteByDate);

// -----------------------
// Registro / Login
// -----------------------
function registrarUsuario(){
  const email=regEmail.value.trim(); const pass=regPass.value;
  regMsg.textContent=''; if(!email||!pass){ regMsg.textContent='Completa los campos'; return;}
  if(db[email]){ regMsg.textContent='Correo ya registrado'; return;}
  db[email]={colillas:0,nivel:0,rango:'Principiante',contraseÃ±a:pass,isAdmin:false,historial:[]};
  saveDB(); regMsg.textContent='Cuenta creada. Ya puedes iniciar sesiÃ³n.';
  setTimeout(()=>{ registroScreen.style.display='none'; loginScreen.style.display='block'; loginEmail.value=email;},900);
}
function login(){
  const email=loginEmail.value.trim(); const pass=loginPass.value;
  loginMsg.textContent=''; if(!email||!pass){ loginMsg.textContent='Completa los campos'; return;}
  if(!db[email] || db[email].contraseÃ±a!==pass){ loginMsg.textContent='Correo o contraseÃ±a incorrectos'; return;}
  sessionStorage.setItem('user', email); iniciarSistema();
}

// -----------------------
// Iniciar sistema
// -----------------------
function iniciarSistema(){
  loginScreen.style.display='none'; registroScreen.style.display='none';
  menu.style.display='flex'; contenido.style.display='block'; loadAdmin();
  const user=sessionStorage.getItem('user');
  if(user && db[user] && db[user].isAdmin){ adminBtn.style.display='inline-block'; } 
  else{ adminBtn.style.display='none'; }
  cargarUsuario(); renderChart(); renderHistorial();
}
function cargarUsuario(){
  const email=sessionStorage.getItem('user'); if(!email) return;
  userLabel.textContent='Usuario: '+email;
  totalUser.textContent=(db[email].colillas||0)+' colillas';
  actualizarInsignias(email);
}

// -----------------------
// Registrar colillas + historial
// -----------------------
function addColillas(){
  const email=sessionStorage.getItem('user'); if(!email){ saveMsg.textContent='Inicia sesiÃ³n primero'; return;}
  const cant=parseInt(colillasInput.value,10); saveMsg.textContent='';
  if(!cant || cant<=0){ saveMsg.textContent='Cantidad invÃ¡lida'; return;}
  if(!db[email]) db[email]={colillas:0,nivel:0,rango:'Principiante',contraseÃ±a:'',isAdmin:false,historial:[]};
  db[email].colillas+=cant;
  const registro={id:'h_'+Date.now()+'_'+Math.floor(Math.random()*9999),fecha:new Date().toLocaleString(),cant:cant};
  db[email].historial.unshift(registro);
  if(db[email].historial.length>500) db[email].historial.length=500;
  saveDB();
  totalUser.textContent=db[email].colillas+' colillas';
  saveMsg.textContent='Registrado correctamente';
  actualizarInsignias(email); renderChart(); renderHistorial(); colillasInput.value='';
}

// -----------------------
// Historial usuario
// -----------------------
function renderHistorial(){
  const email=sessionStorage.getItem('user'); historialLista.innerHTML='';
  if(!email||!db[email]||!db[email].historial||db[email].historial.length===0){
    historialLista.innerHTML='<li class="small">Sin registros</li>'; return;
  }
  db[email].historial.slice(0,100).forEach(it=>{
    const li=document.createElement('li');
    li.innerHTML=`${it.fecha} â€” <strong>${it.cant}</strong> colillas <button style="margin-left:8px" onclick="deleteHist('${it.id}')">ðŸ—‘</button>`;
    historialLista.appendChild(li);
  });
}
function deleteHist(id){
  const email=sessionStorage.getItem('user'); if(!email) return;
  if(!confirm('Â¿Eliminar este registro?')) return;
  db[email].historial=db[email].historial.filter(x=>x.id!==id);
  db[email].colillas=db[email].historial.reduce((s,a)=>s+a.cant,0);
  saveDB(); cargarUsuario(); renderChart(); renderHistorial();
}

// -----------------------
// Borrar por fecha usuario
// -----------------------
function userDeleteByDate(){
  const email=sessionStorage.getItem('user'); if(!email) return;
  const fechaSel=delDate.value; if(!fechaSel){ alert('Selecciona una fecha'); return;}
  const before=db[email].historial.length;
  db[email].historial=db[email].historial.filter(r=>{
    const d=new Date(r.fecha); if(isNaN(d)) return true;
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return !(yyyy+'-'+mm+'-'+dd===fechaSel);
  });
  const removed=before-db[email].historial.length;
  if(removed>0){ db[email].colillas=db[email].historial.reduce((s,a)=>s+a.cant,0); saveDB(); cargarUsuario(); renderChart(); renderHistorial(); alert('Registros eliminados: '+removed);}
  else{ alert('No se encontraron registros en esa fecha.');}
}

// -----------------------
// Insignias / niveles con barra de progreso
// -----------------------
function actualizarInsignias(email){
  const c=db[email].colillas||0;
  let rango='Principiante', nivel=0, icon='ðŸ”°', color='#ffc107';
  if(c>=300){ nivel=3; rango='GuardiÃ¡n Ambiental'; icon='ðŸ†'; color='#28a745'; }
  else if(c>=150){ nivel=2; rango='Protector del Campus'; icon='ðŸŒ¿'; color='#17a2b8'; }
  else if(c>=50){ nivel=1; rango='Recolector Inicial'; icon='ðŸŒ±'; color='#fd7e14'; }
  db[email].nivel=nivel; db[email].rango=rango; saveDB();
  badgeLevel.textContent=nivel; badgeRank.textContent=rango; badgeLevelIcon.textContent=icon;
  const porcentaje=Math.min(c,300)/300*100;
  const fill=document.getElementById('progressColillas');
  fill.style.width=porcentaje+'%'; fill.textContent=Math.floor(porcentaje)+'%'; fill.style.backgroundColor=color;
  badgeLevel.classList.add('pulse'); badgeRank.classList.add('pulse'); badgeLevelIcon.classList.add('pulse');
  setTimeout(()=>{ badgeLevel.classList.remove('pulse'); badgeRank.classList.remove('pulse'); badgeLevelIcon.classList.remove('pulse');},700);
}

// -----------------------
// Chart.js
// -----------------------
function renderChart(){
  const email=sessionStorage.getItem('user');
  const myVal=(email && db[email])? db[email].colillas||0 : 0;
  const total=Object.values(db).reduce((s,v)=> s+(v.colillas||0),0);
  const ctx=chartCanvas.getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{type:'bar',data:{labels:['Total campus','TÃº'],datasets:[{label:'Colillas',data:[total,myVal],backgroundColor:['#7a003c','#2979ff']}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

// -----------------------
// ADMIN funciones
// -----------------------
function loadAdmin(){
  let html='<table class="table"><thead><tr><th>Usuario</th><th>Colillas</th><th>Nivel</th></tr></thead><tbody>';
  Object.keys(db).forEach(u=>{ const it=db[u]; html+=`<tr><td>${u}${it.isAdmin?' (admin)':''}</td><td>${it.colillas||0}</td><td>${it.nivel||0} - ${it.rango||''}</td></tr>`; });
  html+='</tbody></table>'; adminList.innerHTML=html;
  adminUserSelect.innerHTML=Object.keys(db).map(u=>`<option value="${u}">${u}</option>`).join('');
}
function adminDeleteByDate(){ const admin=sessionStorage.getItem('user'); if(!admin||!db[admin]||!db[admin].isAdmin){ alert('Solo el administrador'); return;}
  const target=adminUserSelect.value; const fechaSel=adminDelDate.value;
  if(!target){ alert('Selecciona usuario'); return;} if(!fechaSel){ alert('Selecciona fecha'); return;}
  if(!db[target]||!db[target].historial||db[target].historial.length===0){ alert('Usuario sin historial'); return;}
  const before=db[target].historial.length;
  db[target].historial=db[target].historial.filter(r=>{const d=new Date(r.fecha); if(isNaN(d)) return true; const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return !(yyyy+'-'+mm+'-'+dd===fechaSel);});
  const removed=before-db[target].historial.length;
  db[target].colillas=db[target].historial.reduce((s,a)=>s+a.cant,0); actualizarInsignias(target); saveDB(); loadAdmin(); alert('Registros eliminados: '+removed);}
function adminDeleteAll(){ const admin=sessionStorage.getItem('user'); if(!admin||!db[admin]||!db[admin].isAdmin){ alert('Solo admin'); return;}
  const target=adminUserSelect.value; if(!target){ alert('Selecciona usuario'); return;}
  if(!confirm('Borrar TODO el historial del usuario '+target+' ? Esta acciÃ³n no se puede deshacer.')) return;
  db[target].historial=[]; db[target].colillas=0; db[target].nivel=0; db[target].rango='Principiante'; saveDB(); loadAdmin(); alert('Historial eliminado para '+target);}
function exportCSV(){ const admin=sessionStorage.getItem('user'); if(!admin||!db[admin]||!db[admin].isAdmin){ alert('Solo admin'); return;}
  let csv='usuario,colillas,nivel,rango\n'; for(const u in db){ csv+=`${u},${db[u].colillas||0},${db[u].nivel||0},"${db[u].rango||''}"\n`; }
  const blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='sicce_datos.csv'; a.click(); URL.revokeObjectURL(url);}
function resetAll(){ const admin=sessionStorage.getItem('user'); if(!admin||!db[admin]||!db[admin].isAdmin){ alert('Solo admin'); return;}
  if(!confirm('Reiniciar todos los conteos y historiales?')) return;
  for(const u in db){ db[u].colillas=0; db[u].nivel=0; db[u].rango=db[u].isAdmin?'Administrador':'Principiante'; db[u].historial=[]; }
  saveDB(); loadAdmin(); renderChart(); renderHistorial(); alert('Reinicio completo');}

// -----------------------
// Perfil modal
// -----------------------
function openProfile(){ const email=sessionStorage.getItem('user'); if(!email){ alert('Inicia sesiÃ³n'); return;}
  pEmail.textContent='Correo: '+email; pColillas.textContent='Colillas: '+(db[email].colillas||0); pNivel.textContent='Nivel: '+(db[email].nivel||0)+' â€” '+(db[email].rango||'');
  profileModal.style.display='flex';}
function closeProfile(){ profileModal.style.display='none';}

// -----------------------
// Theme & logout
// -----------------------
function toggleTheme(){ if(document.documentElement.getAttribute('data-theme')==='dark'){ document.documentElement.removeAttribute('data-theme'); localStorage.removeItem('sicce_theme_v1'); btnTheme.textContent='Modo oscuro';}
else{ document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('sicce_theme_v1','dark'); btnTheme.textContent='Modo claro';}}
function logout(){ sessionStorage.removeItem('user'); menu.style.display='none'; contenido.style.display='none'; loginScreen.style.display='block'; loginEmail.value=''; loginPass.value='';}

// -----------------------
// Init on load
// -----------------------
window.addEventListener('load',()=>{
  if(localStorage.getItem('sicce_theme_v1')==='dark'){ document.documentElement.setAttribute('data-theme','dark'); btnTheme.textContent='Modo claro';}
  else{ document.documentElement.removeAttribute('data-theme'); btnTheme.textContent='Modo oscuro';}
  const user=sessionStorage.getItem('user'); if(user && db[user]){ iniciarSistema();} 
  else { loginScreen.style.display='block'; registroScreen.style.display='none'; menu.style.display='none'; contenido.style.display='none';}
});
</script>
</body>
</html>
